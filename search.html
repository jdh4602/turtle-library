<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê±°ë¶ì´ë„ì„œê´€ ë„ì„œ ê²€ìƒ‰</title>

  <style>
    body {
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      margin:0;
      padding:16px;
      background:#f5f5f5;
    }

    button,input,select { font-family: inherit; }

    .app {
      max-width:600px;
      margin:0 auto;
      background:#fff;
      border-radius:12px;
      padding:16px;
      box-shadow:0 2px 6px rgba(0,0,0,.08);
      box-sizing:border-box;
    }

    h1 { margin:0 0 12px; font-size:20px; font-weight:700; color:#333; }

    .info { font-size:13px; color:#666; margin-bottom:12px; }

    /* ê²€ìƒ‰ ì˜ì—­ */
    .search-row {
      display:grid;
      grid-template-columns:
        minmax(0,105px)
        minmax(0,1fr)
        minmax(0,62px);
      gap:8px;
      margin-bottom:16px;
      align-items:center;
    }

    .search-row > * { min-width:0; box-sizing:border-box; }

    select,input {
      font-size:15px;
      padding:10px;
      border-radius:8px;
      border:1px solid #ddd;
      background:#fff;
      height:42px;
    }

    input:focus { border-color:#1976d2; }


    /* ---------------------------
         ğŸ”¹ ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼(ê¸°ì¤€)
       --------------------------- */
    .btn-primary {
      height:42px;
      padding:0 10px;

      /* ğŸ”¸ í°íŠ¸ ìŠ¤íƒ€ì¼ = ê²€ìƒ‰ ë²„íŠ¼ ê¸°ì¤€ */
      font-size:15px;
      font-weight:600;

      /* ğŸ”¸ ìƒ‰ìƒ = ìœ„ì¹˜ë³´ê¸° ë²„íŠ¼ ìƒ‰ìƒ */
      background:#1976d2;
      color:#fff;

      border:none;
      border-radius:8px;

      cursor:pointer;
      white-space:nowrap;

      display:flex;
      align-items:center;
      justify-content:center;

      transition:background .2s;
      box-sizing:border-box;
      font-family:inherit;
    }

    .btn-primary:hover { background:#145ca3; }

    /* ğŸ”¹ ê²€ìƒ‰ ë²„íŠ¼ */
    #searchBtn { width:100%; }

    /* ğŸ”¹ ìœ„ì¹˜ë³´ê¸° ë²„íŠ¼ â€” ê°€ë¡œí­ë§Œ ì»´íŒ©íŠ¸í•˜ê²Œ ì¶•ì†Œ */
    .view-btn {
      @apply btn-primary;
      width:auto;          /* ì¹´ë“œ ì˜¤ë¥¸ìª½ì—ì„œ ê½‰ ì°¨ì§€ ì•Šê²Œ */
      padding:0 12px;      /* ì‚´ì§ ì»´íŒ©íŠ¸ */
      align-self:flex-end; /* ì˜¤ë¥¸ìª½ ë ì •ë ¬ */
    }

    /* ê·¹ì†Œí˜• í™”ë©´ ë³´í˜¸ìš© */
    @media (max-width:360px){
      .search-row { grid-template-columns:1fr; }
      #searchBtn { width:100%; }
    }

    /* ì¹´ë“œ UI */
    .card{
      background:#fafafa;
      border-radius:10px;
      padding:14px 12px;
      border:1px solid #eee;
      margin-bottom:10px;
      display:flex;
      justify-content:space-between;
      align-items:stretch;
      gap:12px;
    }

    .card-left{ flex:1; display:flex; flex-direction:column; }

    .card-right{
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      align-items:flex-end;
      flex-shrink:0;
      min-width:90px;
      gap:6px;
    }

    .title{ font-size:15px; font-weight:700; color:#222; line-height:1.3; word-break:break-all; }

    .author-row{ margin-top:auto; padding-top:10px; font-size:13px; color:#666; line-height:1.3; }

    .barcode-row{ font-size:13px; color:#666; line-height:1.3; margin-top:2px; }

    .location{ font-size:14px; white-space:nowrap; text-align:right; color:#444; }
    .loc-number{ color:#1976d2; font-weight:700; font-size:15px; }

    .view-disabled{ font-size:12px; color:#aaa; margin-top:auto; }

    /* ìœ„ì¹˜ ì´ë¯¸ì§€ íŒì—… */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
      backdrop-filter:blur(2px);
    }

    .overlay.show{ display:flex; }

    .overlay-content{
      background:#fff;
      border-radius:12px;
      padding:8px;
      max-width:90vw;
      max-height:85vh;
      box-shadow:0 4px 12px rgba(0,0,0,.2);
    }

    .overlay-img{ display:block; max-width:100%; max-height:80vh; border-radius:8px; }

    #resultCount{ font-size:13px; font-weight:600; color:#444; margin:4px 0 12px; }
  </style>
</head>

<body>
  <div class="app">
    <h1>ê±°ë¶ì´ë„ì„œê´€ ë„ì„œ ê²€ìƒ‰</h1>

    <div class="info">â€¢ ì¹¸ ë²ˆí˜¸ëŠ” ìœ„ìª½ì¹¸ì´ 1ë²ˆì…ë‹ˆë‹¤.</div>

    <div class="search-row">
      <select id="searchField">
        <option value="title">ì œëª©</option>
        <option value="author">ì‘ê°€</option>
        <option value="id">ë°”ì½”ë“œë²ˆí˜¸</option>
      </select>

      <input id="searchInput" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />

      <button id="searchBtn" class="btn-primary">ê²€ìƒ‰</button>
    </div>

    <div id="resultCount"></div>
    <div id="results"></div>
  </div>

  <div id="overlay" class="overlay">
    <div class="overlay-content">
      <img id="overlayImg" class="overlay-img" alt="ì±…ì¥ ìœ„ì¹˜ ì´ë¯¸ì§€" />
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const app = initializeApp({
      apiKey:"AIzaSyA_BkguverEd0Cz8XA24ktcAodk9TH-GeI",
      authDomain:"turtle-library-book-db.firebaseapp.com",
      projectId:"turtle-library-book-db",
      storageBucket:"turtle-library-book-db.firebasestorage.app"
    });

    const db = getFirestore(app);

    let books=[];
    let doors={};

    const resultsDiv=document.getElementById("results");
    const countDiv=document.getElementById("resultCount");
    const overlay=document.getElementById("overlay");
    const overlayImg=document.getElementById("overlayImg");

    overlay.addEventListener("click",()=>overlay.classList.remove("show"));

    function fmt(n){
      if(!n) return "-";
      const v=parseInt(n,10);
      return Number.isNaN(v)? n : String(v);
    }

    function doorImg(door){
      if(!door) return null;
      const s=String(door);
      if(doors[s]) return doors[s];
      const n=parseInt(s,10);
      return doors[String(n)] || null;
    }

    function render(list){
      resultsDiv.innerHTML="";

      if(!list.length){
        countDiv.textContent="";
        resultsDiv.innerHTML="<div style='text-align:center;color:#888;padding:20px;'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
        return;
      }

      countDiv.textContent=`ê²€ìƒ‰ ê²°ê³¼: ${list.length}ê±´`;

      list.forEach((b)=>{
        const card=document.createElement("div");
        card.className="card";

        const left=document.createElement("div");
        left.className="card-left";

        const title=document.createElement("div");
        title.className="title";
        title.textContent=b.title || "(ì œëª© ì—†ìŒ)";

        const author=document.createElement("div");
        author.className="author-row";
        author.textContent=`ì‘ê°€: ${b.author || "-"}`;

        const barcode=document.createElement("div");
        barcode.className="barcode-row";
        barcode.textContent=`ë°”ì½”ë“œ: ${b.id || "-"}`;

        left.append(title,author,barcode);

        const right=document.createElement("div");
        right.className="card-right";

        const loc=document.createElement("div");
        loc.className="location";
        loc.innerHTML=
          `<span class="loc-number">${fmt(b.door_no)}</span>ë²ˆë¬¸ / `+
          `<span class="loc-number">${fmt(b.slot_no)}</span>ë²ˆì¹¸`;

        right.append(loc);

        const img=doorImg(b.door_no);

        if(img){
          const btn=document.createElement("button");
          btn.className="view-btn btn-primary";
          btn.textContent="ìœ„ì¹˜ë³´ê¸°";
          btn.onclick=()=>{
            overlayImg.src=img;
            overlay.classList.add("show");
          };
          right.append(btn);
        } else {
          const no=document.createElement("div");
          no.className="view-disabled";
          no.textContent="ì´ë¯¸ì§€ ì—†ìŒ";
          right.append(no);
        }

        card.append(left,right);
        resultsDiv.appendChild(card);
      });
    }

    function search(){
      const field=document.getElementById("searchField").value;
      const q=document.getElementById("searchInput").value.trim();

      if(!q){ render([]); return; }

      const ql=q.toLowerCase();

      const list = books
        .filter((b)=>{
          let v =
            field==="title"  ? b.title  :
            field==="author" ? b.author :
            field==="id"     ? b.id     : "";

          if(!v) return false;

          return field==="id"
            ? v.includes(q)
            : v.toLowerCase().includes(ql);
        })
        .sort((a,b)=>
          (a.title||"").localeCompare(b.title||"", "ko", { sensitivity:"base" })
        );

      render(list);
    }

    document.getElementById("searchBtn").onclick=search;
    document.getElementById("searchInput").onkeydown=(e)=>{
      if(e.key==="Enter") search();
    };

    async function load(){
      try{
        const [bookSnap,doorSnap]=await Promise.all([
          getDocs(collection(db,"books")),
          getDocs(collection(db,"doors")),
        ]);

        books = bookSnap.docs.map((d)=>{
          const x=d.data()||{};
          return{
            title:x.title || "",
            author:x.author || "",
            id:x.book_barcode || d.id,
            door_no:x.door_no || "",
            slot_no:x.slot_no || "",
          };
        });

        doors={};
        doorSnap.docs.forEach((d)=>{
          const data=d.data()||{};
          if(data.image_url){
            doors[String(d.id)]=data.image_url;
            const n=parseInt(d.id,10);
            if(!Number.isNaN(n)) doors[String(n)]=data.image_url;
          }
        });

      } catch(err){
        console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:",err);
        resultsDiv.textContent="ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }
    }

    load();
  </script>
</body>
</html>
