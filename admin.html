<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ê±°ë¶ì´ë„ì„œê´€ Â· ë„ì„œ ì…ë ¥ ê´€ë¦¬ì</title>

<style>
body { font-family: system-ui,sans-serif; background:#f5f5f5; padding:16px; }
.app { max-width:760px; margin:0 auto; background:#fff; border-radius:12px;
  padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.08); }

h2 { margin:4px 0 10px }
.row { display:grid; grid-template-columns:130px 1fr; gap:8px; margin-bottom:8px; }
input,select { padding:8px; border-radius:8px; border:1px solid #ccc; font-size:15px; }
button { padding:8px 12px; border-radius:8px; border:none; background:#222; color:#fff; cursor:pointer; }
button:active{opacity:.85}
.preview{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:10px;margin:10px 0;font-size:14px}
.item{background:#f8f8f8;border:1px solid #ddd;border-radius:10px;padding:10px;margin-bottom:6px;font-size:14px}
.note{font-size:12px;color:#777}
.badge{display:inline-block;font-size:11px;padding:2px 6px;border-radius:999px;background:#eee;margin-left:4px;}
</style>
</head>

<body>
<div class="app">
  <h2>ğŸ“š ë„ì„œ ë°ì´í„° ì…ë ¥</h2>

  <div class="note">
    1ï¸âƒ£ ë¨¼ì € ë¬¸ / ì¹¸ ìœ„ì¹˜ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤<br>
    2ï¸âƒ£ ISBN ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ë©´ ì œëª©Â·ì‘ê°€ê°€ ìë™ ì¡°íšŒë©ë‹ˆë‹¤<br>
    3ï¸âƒ£ ë‚´ë¶€ ë°”ì½”ë“œë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ìŠ¤ìº”í•˜ë©´ ëª©ë¡ì— ì¶”ê°€ë©ë‹ˆë‹¤
  </div>

  <hr>

  <div class="row">
    <label>ë¬¸ ë²ˆí˜¸</label>
    <input id="sectionInput" placeholder="ì˜ˆ: A1 / 3 / 12" />
  </div>

  <div class="row">
    <label>ì¹¸ ë²ˆí˜¸</label>
    <input id="shelfInput" placeholder="ì˜ˆ: 1 / 2 / 5" />
  </div>

  <hr>

  <div class="row">
    <label>ISBN</label>
    <input id="isbnInput" placeholder="ISBN ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”" />
  </div>

  <button id="lookupBtn">ISBN ë„ì„œì •ë³´ ì¡°íšŒ</button>

  <div id="lookupPreview" class="preview" style="display:none;"></div>

  <div class="row">
    <label>ë°”ì½”ë“œ ë²ˆí˜¸</label>
    <input id="idInput" placeholder="ë‚´ë¶€ ë°”ì½”ë“œë²ˆí˜¸ ìŠ¤ìº”" />
  </div>

  <button id="addBtn" disabled>ëª©ë¡ì— ì¶”ê°€</button>

  <h3>âœ“ ì…ë ¥ëœ ëª©ë¡</h3>
  <div id="list"></div>

  <button id="downloadBtn">books.csv ë‹¤ìš´ë¡œë“œ</button>
</div>

<script>
let entries = [];
let current = {};

// í…ŒìŠ¤íŠ¸ìš©: êµ­ë¦½ì¤‘ì•™ë„ì„œê´€ë§Œ ê°•ì œë¡œ ì“°ê³  ì‹¶ìœ¼ë©´ true ë¡œ ë°”ê¾¸ê¸°
// true  â†’ Google ë¬´ì‹œ, êµ­ë¦½ì¤‘ì•™ë„ì„œê´€ë§Œ ì‚¬ìš©
// false â†’ Google â†’ ì‹¤íŒ¨ ì‹œ êµ­ë¦½ì¤‘ì•™ë„ì„œê´€ í´ë°±
const TEST_NLK_ONLY = false;

// êµ­ë¦½ì¤‘ì•™ë„ì„œê´€ ISBN ì„œì§€ì •ë³´ Open API ì¸ì¦í‚¤
// (https://www.nl.go.kr > ë„ì„œê´€ ì„œë¹„ìŠ¤ > Open API ì—ì„œ ë°œê¸‰)
const NLK_CERT_KEY = "YOUR_NLK_CERT_KEY";

// DOM ìºì‹±
const sectionInput  = document.getElementById("sectionInput");
const shelfInput    = document.getElementById("shelfInput");
const isbnInput     = document.getElementById("isbnInput");
const idInput       = document.getElementById("idInput");
const lookupBtn     = document.getElementById("lookupBtn");
const addBtn        = document.getElementById("addBtn");
const downloadBtn   = document.getElementById("downloadBtn");
const lookupPreview = document.getElementById("lookupPreview");
const list          = document.getElementById("list");

function csvEscape(val) {
  const v = (val ?? "").toString().replace(/"/g, '""');
  return `"${v}"`;
}

// ---------------------------
// 1) Google Books ì¡°íšŒ
// ---------------------------
async function fetchFromGoogle(isbn) {
  const url = `https://www.googleapis.com/books/v1/volumes?q=isbn:${encodeURIComponent(isbn)}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("Google HTTP " + res.status);

  const data = await res.json();
  if (!data.items || !data.items.length) return null;

  const info = data.items[0].volumeInfo || {};
  return {
    title: info.title || "",
    author: (info.authors || []).join(", ")
  };
}

// ---------------------------
// 2) êµ­ë¦½ì¤‘ì•™ë„ì„œê´€ ISBN ì„œì§€ì •ë³´ API ì¡°íšŒ
//    https://www.nl.go.kr/seoji/SearchApi.do
//    í•„ìˆ˜: cert_key, result_style, page_no, page_size
//    + isbn
// ---------------------------
async function fetchFromNLK(isbn) {
  if (!NLK_CERT_KEY) {
    throw new Error("NLK ì¸ì¦í‚¤(NLK_CERT_KEY)ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
  }

  const params = new URLSearchParams({
    cert_key: NLK_CERT_KEY,
    result_style: "json",
    page_no: "1",
    page_size: "10",
    isbn: isbn
  });

  const url = `https://www.nl.go.kr/seoji/SearchApi.do?${params.toString()}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("NLK HTTP " + res.status);

  const data = await res.json();

  // ì˜ˆìƒ êµ¬ì¡°: { PAGE_NO, TOTAL_COUNT, docs: [ { TITLE, AUTHOR, EA_ISBN, ... }, ... ] }
  let docs = data.docs;

  if (!docs) {
    // ë°©ì–´ ì½”ë“œ: í˜¹ì‹œ ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” ê²½ìš° ëŒ€ë¹„
    if (Array.isArray(data.DOCS)) {
      docs = data.DOCS;
    } else if (data.DOCS && Array.isArray(data.DOCS.docs)) {
      docs = data.DOCS.docs;
    }
  }

  if (!docs || !docs.length) return null;

  const first = docs[0] || {};
  const title = first.TITLE || first.title || "";
  const author = first.AUTHOR || first.author || "";

  if (!title && !author) return null;

  return { title, author };
}

// ---------------------------
// 3) ISBN ì¡°íšŒ (Google â†’ êµ­ë¦½ì¤‘ì•™ë„ì„œê´€ í´ë°±)
// ---------------------------
async function lookupISBN() {
  const isbn    = isbnInput.value.trim();
  const section = sectionInput.value.trim();
  const shelf   = shelfInput.value.trim();

  if (!section || !shelf) {
    alert("ë¨¼ì € ë¬¸ ë²ˆí˜¸ì™€ ì¹¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }
  if (!isbn) {
    alert("ISBN ë°”ì½”ë“œë¥¼ ë¨¼ì € ìŠ¤ìº”í•˜ì„¸ìš”.");
    return;
  }

  let bookInfo = null;
  let source = "";

  // í…ŒìŠ¤íŠ¸ ëª¨ë“œê°€ ì•„ë‹ˆë©´ Google ë¨¼ì € ì‹œë„
  if (!TEST_NLK_ONLY) {
    try {
      bookInfo = await fetchFromGoogle(isbn);
      if (bookInfo && bookInfo.title) {
        source = "google";
      }
    } catch (e) {
      console.warn("Google Books ì¡°íšŒ ì˜¤ë¥˜:", e);
    }
  }

  // Google ê²°ê³¼ ì—†ìœ¼ë©´ êµ­ë¦½ì¤‘ì•™ë„ì„œê´€ ì‹œë„
  if (!bookInfo || !bookInfo.title) {
    try {
      bookInfo = await fetchFromNLK(isbn);
      if (bookInfo && bookInfo.title) {
        source = "nlk";
      }
    } catch (e) {
      console.warn("êµ­ë¦½ì¤‘ì•™ë„ì„œê´€ ISBN ì„œì§€ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:", e);
    }
  }

  if (!bookInfo || !bookInfo.title) {
    alert("í•´ë‹¹ ISBNì˜ ì±… ì •ë³´ë¥¼ Google / êµ­ë¦½ì¤‘ì•™ë„ì„œê´€ ì–´ë””ì—ì„œë„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  current = {
    isbn,
    title: bookInfo.title,
    author: bookInfo.author,
    id: "",
    section,
    shelf,
    note: ""
  };

  lookupPreview.style.display = "block";
  lookupPreview.innerHTML = `
    <b>${current.title}</b>
    <span class="badge">${
      source === "nlk" ? "êµ­ë¦½ì¤‘ì•™ë„ì„œê´€" : "Google Books"
    }</span><br>
    ${current.author || "(ì‘ê°€ ì •ë³´ ì—†ìŒ)"}<br>
    ë¬¸ ${current.section} / ì¹¸ ${current.shelf}<br>
    ISBN: ${current.isbn}<br>
    <span class="note">
      TEST_NLK_ONLY: ${TEST_NLK_ONLY ? "êµ­ë¦½ì¤‘ì•™ë„ì„œê´€ë§Œ ì‚¬ìš©" : "Google â†’ êµ­ë¦½ì¤‘ì•™ë„ì„œê´€ í´ë°±"}
    </span>
  `;

  addBtn.disabled = false;
  idInput.focus();
}

// ---------------------------
// 4) ëª©ë¡ì— ì¶”ê°€
// ---------------------------
function addEntry() {
  const id = idInput.value.trim();
  if (!id) {
    alert("ë‚´ë¶€ ë°”ì½”ë“œë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }

  const entry = { ...current, id };
  entries.push(entry);

  const item = document.createElement("div");
  item.className = "item";
  item.innerHTML = `
    <b>${entry.title}</b><br>
    ${entry.author}<br>
    ë°”ì½”ë“œë²ˆí˜¸: ${entry.id} Â· ë¬¸ ${entry.section} / ì¹¸ ${entry.shelf}
  `;
  list.appendChild(item);

  // ë‹¤ìŒ ì±… ì¤€ë¹„ (ìœ„ì¹˜ëŠ” ìœ ì§€)
  isbnInput.value = "";
  idInput.value = "";
  lookupPreview.style.display = "none";
  addBtn.disabled = true;
  isbnInput.focus();
}

// ---------------------------
// 5) CSV ë‹¤ìš´ë¡œë“œ (Excelìš©, ISBN ê¹¨ì§ ë°©ì§€)
// ---------------------------
function downloadCSV() {
  if (!entries.length) {
    alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const header = ["id","title","author","isbn","section","shelf","note"];
  const rows = [header.join(",")];

  entries.forEach(e => {
    // ì—‘ì…€ì´ 9.78E+12ë¡œ ë°”ê¾¸ì§€ ì•Šê²Œ ="" í˜•ì‹ìœ¼ë¡œ ë„£ê¸°
    const isbnField = e.isbn ? `="${e.isbn}"` : "";

    const row = [
      csvEscape(e.id),
      csvEscape(e.title),
      csvEscape(e.author),
      isbnField,                 // ISBN ì¹¸
      csvEscape(e.section),
      csvEscape(e.shelf),
      csvEscape(e.note || "")
    ].join(",");

    rows.push(row);
  });

  const csv = "\uFEFF" + rows.join("\r\n");
  const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "books.csv";
  a.click();
  URL.revokeObjectURL(url);
}

// ì´ë²¤íŠ¸ ë°”ì¸ë”©
lookupBtn.onclick   = lookupISBN;
addBtn.onclick      = addEntry;
downloadBtn.onclick = downloadCSV;

isbnInput.addEventListener("keydown", e => {
  if (e.key === "Enter") lookupISBN();
});
idInput.addEventListener("keydown", e => {
  if (e.key === "Enter") addEntry();
});
</script>
</body>
</html>
