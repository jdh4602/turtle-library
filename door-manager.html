<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>책장 위치 관리자페이지</title>

  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, sans-serif;
      background: #f5f5f5;
    }

    .app {
      max-width: 720px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,.08);
    }

    h1 {
      margin: 0 0 12px;
      font-size: 20px;
    }

    .section {
      padding: 12px 0;
      border-top: 1px solid #eee;
    }

    .section:first-of-type {
      border-top: none;
    }

    .filter-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .filter-row label {
      color: #555;
    }

    .filter-row select {
      font-size: 13px;
      padding: 4px 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #f8f8f8;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      background: #f3f3f3;
    }

    th,
    td {
      padding: 8px 6px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }

    th {
      font-weight: 600;
      color: #444;
      font-size: 13px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .door-no {
      font-weight: 600;
      font-size: 14px;
    }

    .status {
      font-size: 12px;
    }

    .status-none {
      color: #999;
    }

    .file-link {
      font-size: 12px;
      color: #1976d2;
      text-decoration: none;
      word-break: break-all;
    }

    .file-link:hover {
      text-decoration: underline;
    }

    button {
      min-width: 80px;
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid #1976d2;
      cursor: pointer;
      background: #1976d2;
      color: #fff;
      white-space: nowrap;
    }

    button:hover {
      background: #145ca3;
      border-color: #145ca3;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .loading {
      font-size: 12px;
      color: #666;
      margin: 4px 0 8px;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>책장 위치 관리자페이지</h1>

    <div class="section">
      <div class="filter-row">
        <label for="filterSelect">필터</label>
        <select id="filterSelect">
          <option value="none" selected>이미지 없음</option>
          <option value="has">이미지 있음</option>
          <option value="all">전체</option>
        </select>
      </div>

      <div id="loadState" class="loading">문 번호 목록을 불러오는 중...</div>

      <table>
        <thead>
          <tr>
            <th style="width: 80px;">문 번호</th>
            <th>위치 이미지</th>
            <th style="width: 120px;">파일 등록</th>
          </tr>
        </thead>
        <tbody id="doorTableBody">
          <!-- JS에서 동적 생성 -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA_BkguverEd0Cz8XA24ktcAodk9TH-GeI",
      authDomain: "turtle-library-book-db.firebaseapp.com",
      projectId: "turtle-library-book-db",
      storageBucket: "turtle-library-book-db.firebasestorage.app",
      messagingSenderId: "611950738800",
      appId: "1:611950738800:web:7d9474d358c0a33bd6e3b5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    const doorTableBody = document.getElementById("doorTableBody");
    const loadStateEl = document.getElementById("loadState");
    const filterSelect = document.getElementById("filterSelect");

    let doorList = [];
    let doorMetaMap = {};

    // 기본 필터 = 이미지 없음
    let currentFilter = "none";

    async function loadDoorData() {
      try {
        loadStateEl.textContent = "문 번호 목록을 불러오는 중...";

        const booksSnap = await db.collection("books").get();
        const doorSet = new Set();

        booksSnap.forEach((doc) => {
          const data = doc.data() || {};
          if (data.door_no) doorSet.add(String(data.door_no));
        });

        const doorsSnap = await db.collection("doors").get();
        doorMetaMap = {};
        doorsSnap.forEach((doc) => (doorMetaMap[doc.id] = doc.data() || {}));

        doorList = Array.from(doorSet).sort((a, b) => {
          const na = parseInt(a, 10);
          const nb = parseInt(b, 10);
          if (!isNaN(na) && !isNaN(nb)) return na - nb;
          return a.localeCompare(b);
        });

        renderDoorTable();

        loadStateEl.textContent =
          doorList.length > 0
            ? `총 ${doorList.length}개 문 번호를 불러왔습니다.`
            : "등록된 문 번호가 없습니다.";
      } catch (err) {
        console.error(err);
        loadStateEl.textContent = "오류가 발생했습니다. (콘솔 확인)";
      }
    }

    function renderDoorTable() {
      doorTableBody.innerHTML = "";

      const filtered = doorList.filter((doorNo) => {
        const meta = doorMetaMap[doorNo];
        const hasImage = !!(meta && meta.image_url);

        if (currentFilter === "has") return hasImage;
        if (currentFilter === "none") return !hasImage;
        return true;
      });

      filtered.forEach((doorNo) => {
        const tr = document.createElement("tr");

        const tdDoor = document.createElement("td");
        tdDoor.className = "door-no";
        tdDoor.textContent = doorNo;

        const tdStatus = document.createElement("td");
        const meta = doorMetaMap[doorNo];

        if (meta && meta.image_url) {
          const filePath = meta.storage_path || "";
          const fileName = filePath.split("/").pop() || "이미지 파일";

          const link = document.createElement("a");
          link.href = meta.image_url;
          link.target = "_blank";
          link.rel = "noopener noreferrer";
          link.textContent = fileName;
          link.className = "file-link";

          tdStatus.appendChild(link);
        } else {
          const span = document.createElement("span");
          span.className = "status status-none";
          span.textContent = "이미지 없음";
          tdStatus.appendChild(span);
        }

        const tdAction = document.createElement("td");
        const uploadBtn = document.createElement("button");
        uploadBtn.textContent = "파일 등록";

        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = "image/*";
        fileInput.style.display = "none";

        uploadBtn.addEventListener("click", () => fileInput.click());

        fileInput.addEventListener("change", async () => {
          const file = fileInput.files[0];
          if (!file) return;

          uploadBtn.disabled = true;
          uploadBtn.textContent = "업로드 중...";

          try {
            const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
            const path = `doors/${doorNo}.${ext}`;
            const ref = storage.ref().child(path);

            await ref.put(file);
            const url = await ref.getDownloadURL();

            await db.collection("doors").doc(doorNo).set(
              {
                door_no: doorNo,
                image_url: url,
                storage_path: path,
                updated_at: firebase.firestore.FieldValue.serverTimestamp()
              },
              { merge: true }
            );

            doorMetaMap[doorNo] = {
              ...(doorMetaMap[doorNo] || {}),
              image_url: url,
              storage_path: path
            };

            renderDoorTable();
          } finally {
            uploadBtn.disabled = false;
            uploadBtn.textContent = "파일 등록";
            fileInput.value = "";
          }
        });

        tdAction.appendChild(uploadBtn);
        tdAction.appendChild(fileInput);

        tr.appendChild(tdDoor);
        tr.appendChild(tdStatus);
        tr.appendChild(tdAction);

        doorTableBody.appendChild(tr);
      });
    }

    filterSelect.addEventListener("change", (e) => {
      currentFilter = e.target.value;
      renderDoorTable();
    });

    loadDoorData();
  </script>
</body>
</html>
